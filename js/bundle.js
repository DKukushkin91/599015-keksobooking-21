(()=>{"use strict";(()=>{const e=(e,t)=>Math.round(Math.random()*(t-e)+e),t=()=>{document.querySelectorAll('.map__pins [type="button"]').forEach((e=>e.remove()))},o=()=>{document.querySelector(".map__card")&&document.querySelector(".map__card").remove()};window.util={getRandomNumbers:e,getRandomItem:e=>e[Math.round(Math.floor(Math.random()*e.length))],getRandom:t=>t.slice(0,e(1,t.length)),createPin:(e,t)=>e.appendChild(t),writeAddress:(e,t)=>{document.querySelector("#address").value=`${e}, ${t}`},setDisabled:(e,t)=>{for(let o of e)o.disabled=t},onPinStart:()=>{document.querySelector(".map__pin--main").style.top=window.data.PinStart.Y,document.querySelector(".map__pin--main").style.left=window.data.PinStart.X},restartPage:()=>{document.querySelector(".ad-form").reset(),document.querySelector(".map__filters").reset(),document.querySelector(".ad-form").classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),t(),window.util.setDisabled(document.querySelector(".ad-form").querySelectorAll("fieldset"),!0),window.util.setDisabled(document.querySelector(".map__filters"),!0),o(),document.querySelector(".map__pin--main").addEventListener("mousedown",window.pins.onPinMainActive),window.util.onPinStart(),window.pins.pinCoordinate(),window.picture.removePreview()},onCardRemove:o,onPinsRemove:t,Url:{POST:"https://21.javascript.pages.academy/keksobooking",GET:"https://21.javascript.pages.academy/keksobooking/data"}}})(),window.data={PinSize:{WIDTH:65,HEIGHT:65},Price:{MIN:1e4,MAX:5e4},Room:{MIN:1,MAX:3},LocationX:{MIN:130,MAX:1100},LocationY:{MIN:130,MAX:630},MinPrice:{BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},offerType:{flat:"Квартира",house:"Дом",palace:"Дворец",bungalow:"Бунгало"},MapX:{MIN:0,MAX:1200},MapY:{MIN:130,MAX:630},PinStart:{X:"570px",Y:"375px"},TailSize:{WIDTH:10,HEIGHT:22}},(()=>{const e={OK:200},t=e=>{const t=document.createElement("div");return t.style="\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 800px;\n      height: 50%;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      border-radius: 15px;\n      background-color: rgba(0, 0, 0, 0.9);\n      color: #fff;\n      font-weight: 700;\n      line-height: 1.5;\n      z-index: 100",t.textContent=e,document.querySelector(".map").append(t),t};window.load={dataRetrivial:(o,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{r.status===e.OK?o(r.response):n(t(`Статус ответа: ${r.status} ${r.statusText}`))})),r.addEventListener("error",(()=>{n(t("Произошла ошибка соединения"))})),r.addEventListener("timeout",(()=>{n(t(`Запрос не успел выполниться за ${r.timeout} мс`))})),r.timeout=1e4,r.open("GET",window.util.Url.GET),r.send()},StatusCode:e,TIMEOUT_IN_MS:1e4}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pin--main"),o=()=>{window.util.writeAddress(t.offsetLeft,t.offsetTop)};o();const n=e=>{0===e.button&&(window.main.setActivePage(),window.util.onPinStart(),t.removeEventListener("mousedown",n))};t.addEventListener("mousedown",(e=>{e.preventDefault();let n={x:e.clientX,y:e.clientY};const r=e=>{e.preventDefault(),o();let r=n.x-e.clientX,a=n.y-e.clientY;n={x:e.clientX,y:e.clientY};const i=t.offsetLeft-r,d=t.offsetTop-a;t.style.left=(e=>{const t=window.data.MapX.MAX-window.data.PinSize.WIDTH,o=window.data.MapX.MIN;return e>t?t:e<o?o:e})(i)+"px",t.style.top=(e=>{const t=window.data.MapY.MIN-window.data.PinSize.HEIGHT;return e>window.data.MapY.MAX?window.data.MapY.MAX:e<t?t:e})(d)+"px"},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)})),t.addEventListener("mousedown",n);const r=e=>{"Enter"===e.key&&(window.main.setActivePage(),window.util.writeAddress(t.offsetLeft,t.offsetTop),t.removeEventListener("keydown",r))};t.addEventListener("keydown",r),window.pins={getRenderPin:t=>{const o=e.cloneNode(!0),n=o.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,o.style.left=t.location.x-window.data.PinSize.WIDTH+"px",o.style.top=t.location.y-window.data.PinSize.HEIGHT+"px",o},onPinMainActive:n,pinCoordinate:o,removeActivePin:()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),o=document.querySelector("#type"),n=document.querySelector("#price"),r=document.querySelector(".ad-form"),a=r.querySelector(".ad-form__reset"),i=(e,t,o)=>{e.setAttribute(t,o)},d=()=>{let e=0;switch(o.value){case"bungalow":e=window.data.MinPrice.BUNGALOW;break;case"flat":e=window.data.MinPrice.FLAT;break;case"house":e=window.data.MinPrice.HOUSE;break;case"palace":e=window.data.MinPrice.PALACE}i(n,"placeholder",e),i(n,"min",e)};o.addEventListener("click",(()=>{d()}));const c=document.querySelector("#timein"),s=document.querySelector("#timeout"),u=e=>{c.value=e.target.value,s.value=e.target.value};c.addEventListener("change",u),s.addEventListener("change",u),r.addEventListener("submit",(o=>{window.upload.clientUpload(new FormData(r),(()=>{(()=>{let o="";(e.value<t.value||"100"!==e.value&&"0"===t.value||"100"===e.value&&t.value>"0")&&(o="Количество гостей, не должно привышать количество комнат, 100 комнат не для гостей"),e.setCustomValidity(o)})(),d()})),o.preventDefault()})),window.form={setActiveForm:()=>{r.classList.remove("ad-form--disabled")},onPriceValidation:d,onFormRestart:()=>{const e=t=>{t.preventDefault(),a.removeEventListener("click",e),window.util.restartPage()};a.addEventListener("click",e)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content,o=document.querySelector("#success").content,n=()=>{e.querySelector(".error")&&e.querySelector(".error").remove()},r=()=>{e.querySelector(".success")&&e.querySelector(".success").remove()},a=()=>{const o=t.cloneNode(!0);e.append(o),document.addEventListener("click",n),document.addEventListener("keydown",(e=>{"Escape"===e.key&&n()}))};window.upload={clientUpload:(t,n)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{i.status===window.load.StatusCode.OK?(n(i.response),window.util.restartPage(),(()=>{const t=o.cloneNode(!0);e.append(t),document.addEventListener("click",r),document.addEventListener("keydown",(e=>{"Escape"===e.key&&r()}))})()):a()})),i.addEventListener("error",(()=>{a()})),i.addEventListener("timeout",(()=>{a()})),i.timeout=window.load.TIMEOUT_IN_MS,i.open("POST",window.util.Url.POST),i.send(t)}}})(),(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".map__card");window.card={onPinOpenCard:(o,n)=>{o.addEventListener("click",(()=>{const r=(e=>{const o=t.cloneNode(!0),n=o.querySelector(".popup__photos").querySelector(".popup__photo");return o.querySelector(".popup__photos").removeChild(n),o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=window.data.offerType[e.offer.type],o.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${(e=>{let t="комната";return 1!==e.offer.rooms&&(t="комнаты"),0!==e.offer.rooms&&35!==e.offer.rooms||(t="комнат"),t})(e)} для ${e.offer.guests} ${(e=>1!==e.offer.guests?"гостей":"гостя")(e)}`,o.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,o.querySelector(".popup__features").appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+e),t.appendChild(o)})),t})(e.offer.features)),o.querySelector(".popup__description").textContent=e.offer.description,o.querySelector(".popup__photos").appendChild((e=>{const t=document.createDocumentFragment(),o=document.querySelector("#card").content.querySelector(".popup__photo");return e.forEach((e=>{const n=o.cloneNode(!0);n.src=e,t.appendChild(n)})),t})(e.offer.photos)),o.querySelector(".popup__avatar").src=e.author.avatar,o})(n);window.pins.removeActivePin(),o.classList.add("map__pin--active");const a=e=>{"Escape"===e.key&&i()},i=()=>{document.querySelector(".map__card")&&(window.pins.removeActivePin(),o.classList.add("map__pin--active"),document.querySelector(".map__card").remove(),document.removeEventListener("keydown",a))};document.addEventListener("keydown",a),document.querySelector(".map__card")&&i(),document.querySelector(".map").insertBefore(r,e),r.querySelector(".popup__close").addEventListener("click",(()=>{i()}))}))}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),a=document.querySelector("#housing-guests");let i=[];window.load.dataRetrivial((e=>{i=e,d()}));const d=()=>{const e=window.debounce((()=>{window.util.onPinsRemove(),window.util.onCardRemove(),window.render.onCreatePins()}));t.addEventListener("change",(()=>{e()}))};window.filter={onFilterMapAd:()=>i.filter((i=>{return(i.offer.type===o.value||o.value===e)&&(u=i.offer.price,n.value===e||u<window.data.Price.MIN&&"low"===n.value||u>window.data.Price.MAX&&"high"===n.value||u>=window.data.Price.MIN&&u<=window.data.Price.MAX&&"middle"===n.value)&&(d=i,r.value===e||d.offer.rooms===Number(r.value))&&(s=i.offer.guests,a.value===e||s===Number(a.value))&&(c=i.offer.features,Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((e=>c.includes(e.value))));var d,c,s,u})).slice(0,5)}})(),(()=>{const e=document.querySelector(".map__pins");window.render={onCreatePins:()=>{const t=document.createDocumentFragment();window.filter.onFilterMapAd();for(let e of window.filter.onFilterMapAd()){const o=window.pins.getRenderPin(e);window.card.onPinOpenCard(o,e),t.appendChild(o)}window.util.createPin(e,t)}}})(),window.util.setDisabled(document.querySelector(".ad-form").querySelectorAll("fieldset"),!0),window.util.setDisabled(document.querySelector(".map__filters"),!0),window.main={setActivePage:()=>{window.render.onCreatePins(),document.querySelector(".map").classList.remove("map--faded"),window.util.setDisabled(document.querySelector(".ad-form").querySelectorAll("fieldset"),!1),window.util.setDisabled(document.querySelector(".map__filters"),!1),window.form.setActiveForm(),window.form.onPriceValidation(),window.form.onFormRestart()}},(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector("#images"),r=document.querySelector(".ad-form__photo"),a="img/muffin-grey.svg";r.style.display="flex",r.style.alignItems="center",r.style.padding="0 15px",r.insertAdjacentHTML("afterbegin",'<img src="img/muffin-grey.svg" alt="Фотография жилья" width="40" height="44">');const i=r.firstChild,d=(t,o)=>{t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}}))};d(t,o),d(n,i),window.picture={removePreview:()=>{o.src=a,i.src=a}}})()})();