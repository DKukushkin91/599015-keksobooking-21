(()=>{"use strict";(()=>{const e=(e,t)=>Math.round(Math.random()*(t-e)+e);window.util={getRandomNumbers:e,getRandomItem:e=>e[Math.round(Math.floor(Math.random()*e.length))],getRandom:t=>t.slice(0,e(1,t.length)),createElement:(e,t)=>e.appendChild(t),setDisabled:(e,t)=>{for(let n of e)n.disabled=t},Url:{POST:"https://21.javascript.pages.academy/keksobooking",GET:"https://21.javascript.pages.academy/keksobooking/data"}}})(),window.data={PinSize:{WIDTH:65,HEIGHT:65,POINTER:5},Price:{MIN:1e4,MAX:5e4},Room:{MIN:1,MAX:3},MinPrice:{BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},offerType:{flat:"Квартира",house:"Дом",palace:"Дворец",bungalow:"Бунгало"},MapX:{MIN:0,MAX:1200},MapY:{MIN:138,MAX:551},PinStart:{X:570,Y:375},TailSize:{WIDTH:10,HEIGHT:22},SmallPin:{WIDTH:50,HEIGHT:70}},(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),n=document.querySelector(".ad-form-header__preview img"),o=document.querySelector("#images"),r=document.querySelector(".ad-form__photo");r.style.display="flex",r.style.alignItems="center",r.style.padding="13px 15px",r.insertAdjacentHTML("afterbegin",'<img width="40">');const a=r.firstChild,d=(t,n)=>{t.addEventListener("change",(()=>{const o=t.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result})),e.readAsDataURL(o)}}))};d(t,n),d(o,a),window.picture={removePreview:()=>{n.src="img/muffin-grey.svg",a.src=""}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content,n=document.querySelector("#success").content,o=()=>{const e=document.querySelector(".error");e&&e.remove()},r=()=>{const e=document.querySelector(".success");e&&e.remove()},a=e=>{"Escape"===e.key&&document.querySelector(".error")?(e.preventDefault(),o()):"Escape"===e.key&&document.querySelector(".success")&&(e.preventDefault(),r())};window.message={escPressHandler:a,errorShowHandler:()=>{const n=t.cloneNode(!0);e.append(n),document.removeEventListener("click",o),document.removeEventListener("keydown",a)},successShowHandler:()=>{window.form.restartPage();const t=n.cloneNode(!0);e.append(t),document.removeEventListener("click",r),document.removeEventListener("keydown",a)},successHideHandler:r}})(),(()=>{const e=e=>{const t=document.createElement("div");return t.style="\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 800px;\n      height: 50%;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      border-radius: 15px;\n      background-color: rgba(0, 0, 0, 0.9);\n      color: #fff;\n      font-weight: 700;\n      line-height: 1.5;\n      z-index: 100",t.textContent=e,document.querySelector(".map").append(t),t},t=(t,n,o,r,a)=>{let d=new XMLHttpRequest;d.responseType="json",d.timeout=3e3,d.open(n,t),d.addEventListener("load",(()=>{switch(d.status){case 200:r(d.response),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.successHideHandler);break;case 400:a("Неправильный запрос.  Код ошибки "+d.status),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler);break;case 404:a("Страница не найдена. Код ошибки "+d.status),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler);break;case 500:a("Внутренняя ошибка сервера. Код ошибки "+d.status),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler);break;default:a(`При загрузке произошла ошибка ${d.status} . Повторите попытку позже.`),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler)}})),d.addEventListener("error",(()=>{a(e("Произошла ошибка соединения")),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler)})),d.addEventListener("timeout",(()=>{a(e(`Запрос не успел выполниться за ${d.timeout} мс`)),document.addEventListener("keydown",window.message.escPressHandler),document.addEventListener("click",window.message.errorHideHandler)})),d.send(o)};window.backend={save:(e,n,o)=>{t("https://21.javascript.pages.academy/keksobooking","POST",e,n,o)},load:e=>{t("https://21.javascript.pages.academy/keksobooking/data","GET",null,e)}}})(),(()=>{const e=document.querySelector("#address"),t=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector(".map__pin--main"),o=(t,n)=>{e.value=`${t}, ${n}`},r=()=>{o(n.offsetLeft+Math.floor(window.data.PinSize.WIDTH/2),n.offsetTop+window.data.PinSize.WIDTH+window.data.TailSize.HEIGHT)},a=()=>{o(n.offsetLeft+Math.floor(window.data.PinSize.WIDTH/2),n.offsetTop+Math.floor(window.data.PinSize.WIDTH/2))};a();const d=e=>{0===e.button&&(window.main.setActivePage(),r(),n.removeEventListener("mousedown",d))};n.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault(),r();const o=t.x-e.clientX,a=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const d=n.offsetLeft-o,i=n.offsetTop-a;n.style.left=(e=>{const t=window.data.MapX.MAX-window.data.PinSize.WIDTH/2,n=window.data.MapX.MIN-Math.floor(window.data.PinSize.WIDTH/2);return e>t?t:e<n?n:e})(d)+"px",n.style.top=(e=>{const t=window.data.MapY.MIN-window.data.PinSize.WIDTH-window.data.TailSize.HEIGHT;return e>window.data.MapY.MAX?window.data.MapY.MAX:e<t?t:e})(i)+"px"},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",a)})),n.addEventListener("mousedown",d);const i=e=>{"Enter"===e.key&&(window.main.setActivePage(),r(),n.removeEventListener("keydown",i))};n.addEventListener("keydown",i),window.pins={getRenderElement:e=>{const n=t.cloneNode(!0),o=n.querySelector("img");return o.src=e.author.avatar,o.alt=e.offer.title,n.style.left=e.location.x-window.data.SmallPin.WIDTH+"px",n.style.top=e.location.y-window.data.SmallPin.HEIGHT+"px",n},pinActivePageHandler:d,loadPinCoordinate:a,removeActiveElement:()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")},setElementStart:()=>{n.style.top=window.data.PinStart.Y+"px",n.style.left=window.data.PinStart.X+"px"}}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),n=document.querySelector("#type"),o=document.querySelector("#price"),r=document.querySelector(".ad-form"),a=r.querySelector(".ad-form__reset"),d=r.querySelector(".ad-form__submit");window.util.setDisabled(r.querySelectorAll("fieldset"),!0);const i=()=>{let n="";(e.value<t.value||"100"!==e.value&&"0"===t.value||"100"===e.value&&t.value>"0")&&(n="Количество гостей, не должно привышать количество комнат, 100 комнат не для гостей"),e.setCustomValidity(n)};d.addEventListener("click",i);const s=(e,t,n)=>{e.setAttribute(t,n)},c=()=>{let e=0;switch(n.value){case"bungalow":e=window.data.MinPrice.BUNGALOW;break;case"flat":e=window.data.MinPrice.FLAT;break;case"house":e=window.data.MinPrice.HOUSE;break;case"palace":e=window.data.MinPrice.PALACE}s(o,"placeholder",e),s(o,"min",e)};c(),n.addEventListener("change",c);const l=document.querySelector("#timein"),u=document.querySelector("#timeout"),m=e=>{l.value=e.target.value,u.value=e.target.value};l.addEventListener("change",m),u.addEventListener("change",m);const p=()=>{document.querySelectorAll('.map__pins [type="button"]').forEach((e=>e.remove()))},w=()=>{const e=document.querySelector(".map__card");e&&e.remove()},f=()=>{const e=document.querySelector(".map__filters");r.reset(),e.reset(),r.classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),p(),window.util.setDisabled(r.querySelectorAll("fieldset"),!0),window.util.setDisabled(e,!0),w(),document.querySelector(".map__pin--main").addEventListener("mousedown",window.pins.pinActivePageHandler),window.pins.setElementStart(),window.pins.loadPinCoordinate(),window.picture.removePreview(),c()};r.addEventListener("submit",(e=>{d.removeEventListener("click",i),window.backend.save(new FormData(r),window.message.successShowHandler,window.message.errorShowHandler),e.preventDefault()})),window.form={setActiveElement:()=>{r.classList.remove("ad-form--disabled")},priceValidationHandler:c,buttonRestartHandler:()=>{const e=t=>{t.preventDefault(),a.removeEventListener("click",e),f()};a.addEventListener("click",e)},removePins:p,removeCard:w,restartPage:f}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),300)}},(()=>{const e="any",t=document.querySelector(".map__filters"),n=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),a=document.querySelector("#housing-guests");window.util.setDisabled(t,!0);let d=[];window.backend.load((e=>{d=e,(()=>{const e=window.debounce((()=>{window.form.removePins(),window.form.removeCard(),window.main.createElements()}));t.addEventListener("change",(()=>{e()}))})()}),window.backend.getShowErrorElement);const i=t=>r.value===e||t.offer.rooms===Number(r.value),s=t=>a.value===e||t.offer.guests===Number(a.value),c=e=>Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((t=>e.includes(t.value)));window.filter={getFilteredData:()=>{let t=[];for(let a of d)if((a.offer.type===n.value||n.value===e)&&(r=a,o.value===e||r.offer.price<window.data.Price.MIN&&"low"===o.value||r.offer.price>window.data.Price.MAX&&"high"===o.value||r.offer.price>=window.data.Price.MIN&&r.offer.price<=window.data.Price.MAX&&"middle"===o.value)&&i(a)&&s(a)&&c(a)&&t.push(a),5===t.length)break;var r;return t}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=e=>{"Escape"===e.key&&(e.preventDefault(),n())},n=()=>{const e=document.querySelector(".map__card");e&&(window.pins.removeActiveElement(),e.remove(),document.removeEventListener("keydown",t))};window.card={getRenderElement:t=>{const o=e.cloneNode(!0),r=o.querySelector(".popup__photos").querySelector(".popup__photo"),a=o.querySelector(".popup__close");return o.querySelector(".popup__photos").removeChild(r),o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=window.data.offerType[t.offer.type],o.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} ${(e=>{let t="комната";return 1!==e.offer.rooms&&(t="комнаты"),0!==e.offer.rooms&&35!==e.offer.rooms||(t="комнат"),t})(t)} для ${t.offer.guests} ${(e=>1!==e.offer.guests?"гостей":"гостя")(t)}`,o.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,o.querySelector(".popup__features").appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const n=document.createElement("li");n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e),t.appendChild(n)})),t})(t.offer.features)),o.querySelector(".popup__description").textContent=t.offer.description,o.querySelector(".popup__photos").appendChild((e=>{const t=document.createDocumentFragment(),n=document.querySelector("#card").content.querySelector(".popup__photo");return e.forEach((e=>{const o=n.cloneNode(!0);o.src=e,t.appendChild(o)})),t})(t.offer.photos)),o.querySelector(".popup__avatar").src=t.author.avatar,a.addEventListener("click",n),o},popupCloseHandler:n,escPressHandler:t}})(),(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector(".map"),n=document.querySelector(".map__pins");window.filter.getFilteredData();const o=()=>{const e=document.createDocumentFragment();for(let t of window.filter.getFilteredData()){const n=window.pins.getRenderElement(t);r(n,t),e.appendChild(n)}window.util.createElement(n,e)},r=(n,o)=>{n.addEventListener("click",(()=>{const r=window.card.getRenderElement(o);document.querySelector(".map__card")&&window.card.popupCloseHandler(),document.addEventListener("keydown",window.card.escPressHandler),window.pins.removeActiveElement(),n.classList.add("map__pin--active"),t.insertBefore(r,e)}))};window.main={setActivePage:()=>{o(),t.classList.remove("map--faded"),window.util.setDisabled(document.querySelector(".ad-form").querySelectorAll("fieldset"),!1),window.util.setDisabled(document.querySelector(".map__filters"),!1),window.form.setActiveElement(),window.form.buttonRestartHandler(),window.form.priceValidationHandler()},createElements:o}})()})();