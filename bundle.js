(()=>{"use strict";(()=>{const e=(e,t)=>Math.round(Math.random()*(t-e)+e);window.util={getRandomNumbers:e,getRandomItem:e=>e[Math.round(Math.floor(Math.random()*e.length))],getRandom:t=>t.slice(0,e(1,t.length)),createElement:(e,t)=>e.appendChild(t),setDisabled:(e,t)=>{for(let o of e)o.disabled=t},Url:{POST:"https://21.javascript.pages.academy/keksobooking",GET:"https://21.javascript.pages.academy/keksobooking/data"}}})(),window.data={MAIN_PIN_SIZE:65,Price:{MIN:1e4,MAX:5e4},Room:{MIN:1,MAX:3},MinPrice:{BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},offerType:{flat:"Квартира",house:"Дом",palace:"Дворец",bungalow:"Бунгало"},MapX:{MIN:0,MAX:1200},MapY:{MIN:130,MAX:630},PinStart:{X:570,Y:375},TailSize:{WIDTH:10,HEIGHT:22},SmallPin:{WIDTH:50,HEIGHT:70}},(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector("#images"),r=document.querySelector(".ad-form__photo");r.style.display="flex",r.style.alignItems="center",r.style.padding="13px 15px",r.insertAdjacentHTML("afterbegin",'<img width="40">');const a=r.firstChild,d=(t,o)=>{t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}}))};d(t,o),d(n,a),window.picture={removePreview:()=>{o.src="img/muffin-grey.svg",a.src=""}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content,o=document.querySelector("#success").content,n=(e,t)=>{e&&e.remove(),document.removeEventListener("click",t),document.removeEventListener("keydown",d),window.form.restartPage()},r=()=>{const e=document.querySelector(".error");n(e,r)},a=()=>{const e=document.querySelector(".success");n(e,a)},d=e=>{"Escape"===e.key&&(e.preventDefault(),document.querySelector(".error")?r():document.querySelector(".success")&&a())};window.message={errorShowHandler:()=>{const o=t.cloneNode(!0);e.append(o),document.addEventListener("click",r),document.addEventListener("keydown",d)},successShowHandler:()=>{const t=o.cloneNode(!0);e.append(t),document.addEventListener("click",a),document.addEventListener("keydown",d)},successHideHandler:a}})(),(()=>{const e=e=>{const t=document.createElement("div");return t.style="\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 800px;\n      height: 50%;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      border-radius: 15px;\n      background-color: rgba(0, 0, 0, 0.9);\n      color: #fff;\n      font-weight: 700;\n      line-height: 1.5;\n      z-index: 100",t.textContent=e,document.querySelector(".map").append(t),t},t=(t,o,n,r,a)=>{let d=new XMLHttpRequest;d.responseType="json",d.timeout=3e3,d.open(o,t),d.addEventListener("load",(()=>{switch(d.status){case 200:r(d.response);break;case 400:a("Неправильный запрос.  Код ошибки "+d.status);break;case 404:a("Страница не найдена. Код ошибки "+d.status);break;case 500:a("Внутренняя ошибка сервера. Код ошибки "+d.status);break;default:a(`При загрузке произошла ошибка ${d.status} . Повторите попытку позже.`)}})),d.addEventListener("error",(()=>{a(e("Произошла ошибка соединения"))})),d.addEventListener("timeout",(()=>{a(e(`Запрос не успел выполниться за ${d.timeout} мс`))})),d.send(n)};window.backend={save:(e,o,n)=>{t("https://21.javascript.pages.academy/keksobooking","POST",e,o,n)},load:e=>{t("https://21.javascript.pages.academy/keksobooking/data","GET",null,e)}}})(),(()=>{const e=document.querySelector("#address"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map__pin--main"),n=(t,o)=>{e.value=`${t}, ${o}`},r=()=>{n(o.offsetLeft+Math.floor(window.data.MAIN_PIN_SIZE/2),o.offsetTop+window.data.MAIN_PIN_SIZE+window.data.TailSize.HEIGHT)},a=()=>{n(o.offsetLeft+Math.floor(window.data.MAIN_PIN_SIZE/2),o.offsetTop+Math.floor(window.data.MAIN_PIN_SIZE/2))};a();const d=e=>{0===e.button&&(window.main.setActivePage(),r(),o.removeEventListener("mousedown",d))};o.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault(),r();const n=t.x-e.clientX,a=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const d=o.offsetLeft-n,c=o.offsetTop-a;o.style.left=(e=>{const t=window.data.MapX.MAX-window.data.MAIN_PIN_SIZE/2,o=window.data.MapX.MIN-Math.floor(window.data.MAIN_PIN_SIZE/2);return e>t?t:e<o?o:e})(d)+"px",o.style.top=(e=>{const t=e=>e-window.data.MAIN_PIN_SIZE-window.data.TailSize.HEIGHT;return e>t(window.data.MapY.MAX)?t(window.data.MapY.MAX):e<t(window.data.MapY.MIN)?t(window.data.MapY.MIN):e})(c)+"px"},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)})),o.addEventListener("mousedown",d);const c=e=>{"Enter"===e.key&&(window.main.setActivePage(),r(),o.removeEventListener("keydown",c))};o.addEventListener("keydown",c),window.pins={getRenderElement:e=>{const o=t.cloneNode(!0),n=o.querySelector("img");return n.src=e.author.avatar,n.alt=e.offer.title,o.style.left=e.location.x-window.data.SmallPin.WIDTH/2+"px",o.style.top=e.location.y-window.data.SmallPin.HEIGHT/2+"px",o},pinActivePageHandler:d,loadPinCoordinate:a,removeActiveElement:()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")},setElementStart:()=>{o.style.top=window.data.PinStart.Y+"px",o.style.left=window.data.PinStart.X+"px"}}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),o=document.querySelector("#type"),n=document.querySelector("#price"),r=document.querySelector(".ad-form"),a=r.querySelector(".ad-form__reset"),d=r.querySelector(".ad-form__submit");window.util.setDisabled(r,!0);const c=()=>{let o="";(e.value<t.value||"100"!==e.value&&"0"===t.value||"100"===e.value&&t.value>"0")&&(o="Количество гостей, не должно привышать количество комнат, 100 комнат не для гостей"),e.setCustomValidity(o)};d.removeEventListener("click",c);const i=(e,t,o)=>{e.setAttribute(t,o)},s=()=>{let e=0;switch(o.value){case"bungalow":e=window.data.MinPrice.BUNGALOW;break;case"flat":e=window.data.MinPrice.FLAT;break;case"house":e=window.data.MinPrice.HOUSE;break;case"palace":e=window.data.MinPrice.PALACE}i(n,"placeholder",e),i(n,"min",e)};s(),o.addEventListener("change",s);const l=document.querySelector("#timein"),u=document.querySelector("#timeout"),m=e=>{l.value=e.target.value,u.value=e.target.value};l.addEventListener("change",m),u.addEventListener("change",m);const p=()=>{document.querySelectorAll('.map__pins [type="button"]').forEach((e=>e.remove()))},w=()=>{const e=document.querySelector(".map__card");e&&e.remove()},f=()=>{const e=document.querySelector(".map__filters");r.reset(),e.reset(),window.util.setDisabled(r,!0),window.util.setDisabled(e,!0),r.classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),p(),w(),document.querySelector(".map__pin--main").addEventListener("mousedown",window.pins.pinActivePageHandler),window.pins.setElementStart(),window.pins.loadPinCoordinate(),window.picture.removePreview(),s()};r.addEventListener("submit",(e=>{window.backend.save(new FormData(r),window.message.successShowHandler,window.message.errorShowHandler),e.preventDefault()})),d.addEventListener("click",c),window.form={setActiveElement:()=>{r.classList.remove("ad-form--disabled")},priceValidationHandler:s,buttonRestartHandler:()=>{const e=t=>{t.preventDefault(),a.removeEventListener("click",e),f()};a.addEventListener("click",e)},removePins:p,removeCard:w,restartPage:f}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),a=document.querySelector("#housing-guests");window.util.setDisabled(t,!0);let d=[];window.backend.load((e=>{d=e,(()=>{const e=window.debounce((()=>{window.form.removePins(),window.form.removeCard(),window.main.createElements()}));t.addEventListener("change",(()=>{e()}))})()}),window.backend.getShowErrorElement);const c=e=>Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((t=>e.includes(t.value)));window.filter={getFilteredData:()=>{const t=[];for(let u of d)if((u.offer.type===o.value||o.value===e)&&(l=u.offer.price,n.value===e||l<window.data.Price.MIN&&"low"===n.value||l>window.data.Price.MAX&&"high"===n.value||l>=window.data.Price.MIN&&l<=window.data.Price.MAX&&"middle"===n.value)&&(s=u.offer.rooms,r.value===e||s===Number(r.value))&&(i=u.offer.guests,a.value===e||i===Number(a.value))&&c(u.offer.features)&&t.push(u),5===t.length)break;var i,s,l;return t}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=e=>{"Escape"===e.key&&(e.preventDefault(),o())},o=()=>{const e=document.querySelector(".map__card");e&&(window.pins.removeActiveElement(),e.remove(),document.removeEventListener("keydown",t))};window.card={getRenderElement:t=>{const n=e.cloneNode(!0),r=n.querySelector(".popup__photos").querySelector(".popup__photo"),a=n.querySelector(".popup__close");return n.querySelector(".popup__photos").removeChild(r),n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.offerType[t.offer.type],n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} ${(e=>{let t="комната";return 1!==e.offer.rooms&&(t="комнаты"),0!==e.offer.rooms&&35!==e.offer.rooms||(t="комнат"),t})(t)} для ${t.offer.guests} ${(e=>1!==e.offer.guests?"гостей":"гостя")(t)}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,n.querySelector(".popup__features").appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+e),t.appendChild(o)})),t})(t.offer.features)),n.querySelector(".popup__description").textContent=t.offer.description,n.querySelector(".popup__photos").appendChild((e=>{const t=document.createDocumentFragment(),o=document.querySelector("#card").content.querySelector(".popup__photo");return e.forEach((e=>{const n=o.cloneNode(!0);n.src=e,t.appendChild(n)})),t})(t.offer.photos)),n.querySelector(".popup__avatar").src=t.author.avatar,a.addEventListener("click",o),n},popupCloseHandler:o,escPressHandler:t}})(),(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector(".map"),o=document.querySelector(".map__pins");window.filter.getFilteredData();const n=()=>{const e=document.createDocumentFragment();for(let t of window.filter.getFilteredData()){const o=window.pins.getRenderElement(t);r(o,t),e.appendChild(o)}window.util.createElement(o,e)},r=(o,n)=>{o.addEventListener("click",(()=>{const r=window.card.getRenderElement(n);document.querySelector(".map__card")&&window.card.popupCloseHandler(),document.addEventListener("keydown",window.card.escPressHandler),window.pins.removeActiveElement(),o.classList.add("map__pin--active"),t.insertBefore(r,e)}))};window.main={setActivePage:()=>{n(),t.classList.remove("map--faded"),window.util.setDisabled(document.querySelector(".ad-form"),!1),window.util.setDisabled(document.querySelector(".map__filters"),!1),window.form.setActiveElement(),window.form.buttonRestartHandler(),window.form.priceValidationHandler()},createElements:n}})()})();